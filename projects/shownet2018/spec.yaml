
postinit:
  - cmds:
      - cmd: docker cp $HOME/dotfiles/bin/ovs-port.py P1:/usr/bin/ovs-port.py

nodes:

  - name: P1
    image: slankdev/ovs
    interfaces:
      - { name: to_R1_net0, type: direct, args: R1#net0 }
      - { name: to_R2_net0, type: direct, args: R2#net0 }
      - { name: to_R3_net0, type: direct, args: R3#net0 }
      - { name: to_R4_net0, type: direct, args: R4#net0 }
      - { name: to_F1_net0, type: direct, args: F1#net0 }
      - { name: to_F1_net1, type: direct, args: F1#net1 }
      - { name: to_F2_net0, type: direct, args: F2#net0 }
      - { name: to_F2_net1, type: direct, args: F2#net1 }
      - { name: veth0, type: phys }

  - name: R1
    image: slankdev/frr
    interfaces: [ { name: net0, type: direct, args: P1#to_R1_net0 } ]
  - name: R2
    image: slankdev/frr
    interfaces: [ { name: net0, type: direct, args: P1#to_R2_net0 } ]
  - name: R3
    image: slankdev/frr
    interfaces: [ { name: net0, type: direct, args: P1#to_R3_net0 } ]
  - name: R4
    image: slankdev/frr
    interfaces: [ { name: net0, type: direct, args: P1#to_R4_net0 } ]

  - name: F1
    image: slankdev/frr
    interfaces:
    - { name: net0, type: direct, args: P1#to_F1_net0 }
    - { name: net1, type: direct, args: P1#to_F1_net1 }
  - name: F2
    image: slankdev/frr
    interfaces:
    - { name: net0, type: direct, args: P1#to_F2_net0 }
    - { name: net1, type: direct, args: P1#to_F2_net1 }


node_configs:

  - name: P1
    cmds:
      - cmd: ip link set veth0 up
      - cmd: ovs-vsctl add-br ovs0
      - cmd: ip link set ovs0 up
      - cmd: ovs-vsctl add-port ovs0 veth0 trunks=110,111,120,121,210,211,220,221
      - cmd: ovs-vsctl add-port ovs0 to_R1_net0 tag=110
      - cmd: ovs-vsctl add-port ovs0 to_R2_net0 tag=111
      - cmd: ovs-vsctl add-port ovs0 to_R3_net0 tag=120
      - cmd: ovs-vsctl add-port ovs0 to_R4_net0 tag=121
      - cmd: ovs-vsctl add-port ovs0 to_F1_net0 tag=210
      - cmd: ovs-vsctl add-port ovs0 to_F1_net1 tag=211
      - cmd: ovs-vsctl add-port ovs0 to_F2_net0 tag=220
      - cmd: ovs-vsctl add-port ovs0 to_F2_net1 tag=221

  - name: R1
    cmds:
      - cmd: sysctl -w net.ipv6.conf.all.keep_addr_on_down=1
      - cmd: sysctl -w net.ipv6.conf.default.keep_addr_on_down=1
      - cmd: sysctl -w net.ipv6.conf.net0.keep_addr_on_down=1

      - cmd: sh -c "enable_seg6_router.py | sh"
      - cmd: /usr/lib/frr/frr start
      - cmd: ip link set dev net0 address 52:54:00:01:10:2
      - cmd: >-
          vtysh -c 'conf t'
          -c 'int net0'
          -c ' ipv6 address cafe:110::2/64'
          -c ' ipv6 ospf6 network point-to-point'
          -c ' ipv6 ospf6 dead-interval 40'
          -c ' ipv6 ospf6 hello-interval 10'
          -c ' exit'
          -c 'router ospf6'
          -c ' ospf6 router-id 10.255.0.201'
          -c ' interface net0 area 0.0.0.0'
          -c ' exit'
  - name: R2
    cmds:
      - cmd: sh -c "enable_seg6_router.py | sh"
      - cmd: /usr/lib/frr/frr start
      - cmd: ip link set dev net0 address 52:54:00:01:11:2
      - cmd: >-
          vtysh -c 'conf t'
          -c 'int net0'
          -c ' ipv6 address cafe:111::2/64'
          -c ' ipv6 ospf6 network point-to-point'
          -c ' ipv6 ospf6 dead-interval 40'
          -c ' ipv6 ospf6 hello-interval 10'
          -c ' exit'
          -c 'router ospf6'
          -c ' ospf6 router-id 10.255.0.202'
          -c ' interface net0 area 0.0.0.0'
          -c ' exit'
  - name: R3
    cmds:
      - cmd: sh -c "enable_seg6_router.py | sh"
      - cmd: /usr/lib/frr/frr start
      - cmd: ip link set dev net0 address 52:54:00:01:20:2
      - cmd: >-
          vtysh -c 'conf t'
          -c 'int net0'
          -c ' ipv6 address cafe:120::2/64'
          -c ' ipv6 ospf6 network point-to-point'
          -c ' ipv6 ospf6 dead-interval 40'
          -c ' ipv6 ospf6 hello-interval 10'
          -c ' exit'
          -c 'router ospf6'
          -c ' ospf6 router-id 10.255.0.203'
          -c ' interface net0 area 0.0.0.0'
          -c ' exit'
  - name: R4
    cmds:
      - cmd: sh -c "enable_seg6_router.py | sh"
      - cmd: ip link set dev net0 address 52:54:00:01:21:2
      - cmd: /usr/lib/frr/frr start
      - cmd: >-
          vtysh -c 'conf t'
          -c 'int net0'
          -c ' ipv6 address cafe:121::2/64'
          -c ' ipv6 ospf6 network point-to-point'
          -c ' ipv6 ospf6 dead-interval 40'
          -c ' ipv6 ospf6 hello-interval 10'
          -c ' exit'
          -c 'router ospf6'
          -c ' ospf6 router-id 10.255.0.204'
          -c ' interface net0 area 0.0.0.0'
          -c ' exit'

  - name: F1
    cmds:
      - cmd: sh -c "enable_seg6_router.py | sh"
      - cmd: sh -c "disable_seg6_router.py | sh"
      - cmd: ip link set dev net0 address 52:54:00:02:10:2
      - cmd: ip link set dev net1 address 52:54:00:02:11:2
      - cmd: /usr/lib/frr/frr start
      - cmd: >-
          vtysh -c 'conf t'
          -c 'int net0'
          -c ' ipv6 address cafe:210::2/64'
          -c ' ipv6 ospf6 network point-to-point'
          -c ' ipv6 ospf6 dead-interval 40'
          -c ' ipv6 ospf6 hello-interval 10'
          -c ' exit'
          -c 'int net1'
          -c ' ipv6 address cafe:211::2/64'
          -c ' ipv6 ospf6 network point-to-point'
          -c ' ipv6 ospf6 dead-interval 40'
          -c ' ipv6 ospf6 hello-interval 10'
          -c ' exit'
          -c 'router ospf6'
          -c ' ospf6 router-id 10.255.0.100'
          -c ' interface net0 area 0.0.0.0'
          -c ' interface net1 area 0.0.0.0'
          -c ' exit'
  - name: F2
    cmds:
      - cmd: sh -c "enable_seg6_router.py | sh"
      - cmd: sh -c "disable_seg6_router.py | sh"
      - cmd: ip link add br0 type bridge
      - cmd: ip link set net0 master br0
      - cmd: ip link set net1 master br0
      - cmd: ip link set br0 up
      - cmd: ip link set net0 up
      - cmd: ip link set net1 up

